<div class="nueva-reserva-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <button mat-icon-button class="btn-back" (click)="cancelar()" matTooltip="Volver al dashboard">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="header-text">
        <h1 class="page-title">
          <mat-icon>{{ modoEdicion ? 'edit' : 'add_circle' }}</mat-icon>
          {{ tituloPagina }}
        </h1>
        <p class="page-subtitle">{{ modoEdicion ? 'Modificar los datos de la reserva existente' : 'Crear una nueva reserva para el hostal' }}</p>
      </div>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div class="loading-container" *ngIf="cargando">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Cargando datos...</p>
  </div>

  <!-- Formulario de Reserva -->
  <form [formGroup]="reservaForm" (ngSubmit)="guardarReserva()" class="reserva-form" *ngIf="!cargando">
    
    <!-- Información del Cliente -->
    <mat-card class="form-section">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>person</mat-icon>
          Información del Cliente
        </mat-card-title>
        <mat-card-subtitle>Datos del cliente (opcional - puede completarse más tarde)</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="form-row">
           <mat-form-field appearance="outline" class="form-field-half">
             <mat-label>Nombre</mat-label>
             <input type="text" matInput 
                    formControlName="nombreCliente"
                    placeholder="Nombre del cliente (opcional)">
           </mat-form-field>

          <mat-form-field appearance="outline" class="form-field-half">
            <mat-label>Apellido</mat-label>
            <input type="text" matInput 
                   formControlName="apellidoCliente"
                   placeholder="Apellido del cliente (opcional)">
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field-half">
            <mat-label>Email</mat-label>
            <input type="email" matInput 
                   formControlName="emailCliente"
                   placeholder="email@ejemplo.com (opcional)">
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field-half">
            <mat-label>Teléfono</mat-label>
            <input type="tel" matInput 
                   formControlName="telefonoCliente"
                   placeholder="Número de teléfono (opcional)">
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field-half">
            <mat-label>Documento</mat-label>
            <input type="text" matInput 
                   formControlName="documentoCliente"
                   placeholder="DNI, Pasaporte, etc. (opcional)">
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field-half">
            <mat-label>Nacionalidad</mat-label>
            <input type="text" matInput 
                   formControlName="nacionalidadCliente"
                   placeholder="País de origen">
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field-full">
            <mat-label>Dirección</mat-label>
            <input type="text" matInput 
                   formControlName="direccionCliente"
                   placeholder="Dirección completa del cliente (opcional)">
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Información de la Habitación -->
    <mat-card class="form-section">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>bed</mat-icon>
          Información de la Habitación
        </mat-card-title>
        <mat-card-subtitle>Seleccione la habitación para la reserva</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field-full">
            <mat-label>Habitación</mat-label>
            <input type="text" matInput 
                   [value]="getHabitacionSeleccionadaTexto()"
                   (click)="abrirSelectorHabitaciones()"
                   placeholder="Haga clic para seleccionar una habitación"
                   readonly>
            <button matSuffix mat-icon-button 
                    (click)="abrirSelectorHabitaciones()"
                    matTooltip="Seleccionar habitación"
                    type="button">
              <mat-icon>search</mat-icon>
            </button>
            <mat-error *ngIf="isFieldInvalid('habitacion')">
              {{ getErrorMessage('habitacion') }}
            </mat-error>
            <mat-hint>Haga clic en el campo o en el botón de búsqueda para seleccionar una habitación</mat-hint>
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Fechas y Horarios -->
    <mat-card class="form-section">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>event</mat-icon>
          Fechas y Horarios
        </mat-card-title>
        <mat-card-subtitle>Defina las fechas de entrada y salida</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field-half">
            <mat-label>Fecha de Entrada</mat-label>
            <input matInput [matDatepicker]="pickerEntrada" 
                   formControlName="fechaEntrada"
                   placeholder="Seleccione fecha de entrada">
            <mat-datepicker-toggle matSuffix [for]="pickerEntrada"></mat-datepicker-toggle>
            <mat-datepicker #pickerEntrada></mat-datepicker>
            <mat-error *ngIf="isFieldInvalid('fechaEntrada')">
              {{ getErrorMessage('fechaEntrada') }}
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field-half">
            <mat-label>Fecha de Salida</mat-label>
            <input matInput [matDatepicker]="pickerSalida" 
                   formControlName="fechaSalida"
                   placeholder="Seleccione fecha de salida">
            <mat-datepicker-toggle matSuffix [for]="pickerSalida"></mat-datepicker-toggle>
            <mat-datepicker #pickerSalida></mat-datepicker>
            <mat-error *ngIf="isFieldInvalid('fechaSalida')">
              {{ getErrorMessage('fechaSalida') }}
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field-half">
            <mat-label>Hora de Entrada</mat-label>
            <input type="time" matInput formControlName="horaEntrada">
            <mat-error *ngIf="isFieldInvalid('horaEntrada')">
              {{ getErrorMessage('horaEntrada') }}
            </mat-error>
            <mat-hint>Hora de llegada del huésped</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field-half">
            <mat-label>Hora de Salida</mat-label>
            <input type="time" matInput formControlName="horaSalida">
            <mat-error *ngIf="isFieldInvalid('horaSalida')">
              {{ getErrorMessage('horaSalida') }}
            </mat-error>
            <mat-hint>Hora de salida del huésped</mat-hint>
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Información de Precios -->
    <mat-card class="form-section">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>attach_money</mat-icon>
          Información de Precios
        </mat-card-title>
        <mat-card-subtitle>Configuración de tarifas y cálculo automático</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field-half">
            <mat-label>Precio por Noche</mat-label>
            <input type="number" matInput formControlName="precioPorNoche"
                   placeholder="0.00">
            <span matPrefix>$&nbsp;</span>
            <mat-error *ngIf="isFieldInvalid('precioPorNoche')">
              {{ getErrorMessage('precioPorNoche') }}
            </mat-error>
            <mat-hint>Precio por noche de la habitación</mat-hint>
          </mat-form-field>

          <div class="info-display form-field-half">
            <div class="info-item">
              <label>Número de Noches:</label>
              <span class="info-value">{{ numeroNoches }}</span>
            </div>
            <div class="info-item total">
              <label>Precio Total:</label>
              <span class="info-value total-price">${{ precioTotal | number:'1.2-2' }}</span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Estado y Pagos -->
    <mat-card class="form-section">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>settings</mat-icon>
          Estado y Pagos
        </mat-card-title>
        <mat-card-subtitle>Configuración del estado de la reserva y método de pago</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field-half">
            <mat-label>Estado de la Reserva</mat-label>
            <mat-select formControlName="estado">
              <mat-option *ngFor="let estado of estadosReserva" [value]="estado">
                {{ estado }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="isFieldInvalid('estado')">
              {{ getErrorMessage('estado') }}
            </mat-error>
          </mat-form-field>

          <div class="checkbox-field form-field-half">
            <mat-checkbox formControlName="pagado" color="primary">
              Reserva Pagada
            </mat-checkbox>
            <mat-hint>Marque si la reserva ya está pagada</mat-hint>
          </div>
        </div>

        <div class="form-row" *ngIf="reservaForm.get('pagado')?.value">
          <mat-form-field appearance="outline" class="form-field-full">
            <mat-label>Método de Pago</mat-label>
            <mat-select formControlName="metodoPago">
              <mat-option *ngFor="let metodo of metodosPago" [value]="metodo">
                {{ metodo }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="isFieldInvalid('metodoPago')">
              {{ getErrorMessage('metodoPago') }}
            </mat-error>
            <mat-hint>Seleccione el método de pago utilizado</mat-hint>
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Configuración de Camas -->
    <mat-card class="form-section">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>bed</mat-icon>
          Configuración de Camas
        </mat-card-title>
        <mat-card-subtitle>Especifique los tipos y cantidades de camas requeridas</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div formArrayName="configuracionCamas" class="camas-container">
          <div *ngFor="let cama of camas.controls; let i = index" [formGroupName]="i" class="cama-item">
            <div class="cama-header">
              <h5>Cama {{ i + 1 }}</h5>
              <button type="button" mat-icon-button color="warn" (click)="eliminarCama(i)" 
                      class="btn-eliminar-cama" matTooltip="Eliminar cama">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
            
            <div class="cama-fields">
              <mat-form-field appearance="outline" class="form-field-tipo">
                <mat-label>Tipo de Cama</mat-label>
                <mat-select formControlName="tipo">
                  <mat-option value="matrimonial">🛏️ Matrimonial</mat-option>
                  <mat-option value="single">🛏️ Single</mat-option>
                  <mat-option value="doble">🛏️ Doble</mat-option>
                  <mat-option value="queen">🛏️ Queen</mat-option>
                  <mat-option value="king">🛏️ King</mat-option>
                </mat-select>
                <mat-hint>Seleccione el tipo de cama</mat-hint>
              </mat-form-field>
              
              <mat-form-field appearance="outline" class="form-field-cantidad">
                <mat-label>Cantidad</mat-label>
                <input matInput type="number" formControlName="cantidad" min="1" max="10">
                <mat-hint>Número de camas</mat-hint>
              </mat-form-field>
            </div>
          </div>
        </div>
        
        <div class="add-cama-section">
          <button type="button" mat-raised-button color="primary" (click)="agregarCama()" class="btn-agregar-cama">
            <mat-icon>add</mat-icon>
            Agregar Nueva Cama
          </button>
          <p class="add-cama-hint" *ngIf="camas.length === 0">
            <mat-icon>info</mat-icon>
            No hay camas configuradas. Haga clic en "Agregar Nueva Cama" para comenzar.
          </p>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Información de Transporte -->
    <mat-card class="form-section">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>directions_car</mat-icon>
          Información de Transporte
        </mat-card-title>
        <mat-card-subtitle>Especifique cómo llegará el cliente</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field-half">
            <mat-label>Tipo de Transporte</mat-label>
            <mat-select formControlName="tipoTransporte">
              <mat-option value="">Seleccionar...</mat-option>
              <mat-option value="vehiculo_propio">Vehículo Propio</mat-option>
              <mat-option value="colectivo">Colectivo</mat-option>
              <mat-option value="taxi">Taxi</mat-option>
              <mat-option value="otro">Otro</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <!-- Campos específicos según el tipo de transporte -->
        <div class="form-row" *ngIf="reservaForm.get('tipoTransporte')?.value === 'vehiculo_propio'">
          <mat-form-field appearance="outline" class="form-field-half">
            <mat-label>Número de Placa</mat-label>
            <input matInput formControlName="numeroPlaca" placeholder="ABC-123">
            <mat-hint>Placa del vehículo (opcional)</mat-hint>
          </mat-form-field>
        </div>

        <div class="form-row" *ngIf="reservaForm.get('tipoTransporte')?.value === 'colectivo'">
          <mat-form-field appearance="outline" class="form-field-half">
            <mat-label>Empresa de Transporte</mat-label>
            <input matInput formControlName="empresa" placeholder="Empresa de colectivos">
            <mat-hint>Nombre de la empresa (opcional)</mat-hint>
          </mat-form-field>
        </div>

        <div class="form-row" *ngIf="reservaForm.get('tipoTransporte')?.value">
          <mat-form-field appearance="outline" class="form-field-full">
            <mat-label>Detalles Adicionales</mat-label>
            <textarea matInput formControlName="detallesTransporte" 
                      rows="2" placeholder="Información adicional sobre el transporte..."></textarea>
            <mat-hint>Detalles adicionales sobre el transporte (opcional)</mat-hint>
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Necesidades Especiales -->
    <mat-card class="form-section">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>accessibility</mat-icon>
          Necesidades Especiales
        </mat-card-title>
        <mat-card-subtitle>Información sobre requerimientos especiales del cliente</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field-full">
            <mat-label>Necesidades Especiales</mat-label>
            <textarea matInput formControlName="necesidadesEspeciales" 
                      rows="3" placeholder="Accesibilidad, dietas especiales, etc..."></textarea>
            <mat-hint>Describa cualquier necesidad especial del cliente (opcional)</mat-hint>
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Observaciones -->
    <mat-card class="form-section">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>note</mat-icon>
          Observaciones
        </mat-card-title>
        <mat-card-subtitle>Información adicional sobre la reserva</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field-full">
            <mat-label>Observaciones</mat-label>
            <textarea matInput formControlName="observaciones" 
                      rows="4"
                      placeholder="Agregue observaciones especiales, solicitudes del cliente, etc..."></textarea>
            <mat-error *ngIf="isFieldInvalid('observaciones')">
              {{ getErrorMessage('observaciones') }}
            </mat-error>
            <mat-hint>Información adicional sobre la reserva</mat-hint>
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Botones de Acción -->
    <div class="form-actions">
      <button type="button" mat-button class="btn-cancelar" (click)="cancelar()">
        <mat-icon>cancel</mat-icon>
        Cancelar
      </button>
      
      <button type="submit" mat-raised-button color="primary" 
              class="btn-guardar"
              [disabled]="reservaForm.invalid || guardando">
        <mat-icon *ngIf="!guardando">{{ modoEdicion ? 'update' : 'save' }}</mat-icon>
        <mat-spinner *ngIf="guardando" diameter="20"></mat-spinner>
        {{ guardando ? (modoEdicion ? 'Actualizando...' : 'Creando...') : textoBotonGuardar }}
      </button>
    </div>
  </form>
</div>

