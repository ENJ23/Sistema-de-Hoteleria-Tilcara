<div class="auditoria-reservas-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <button mat-icon-button class="back-button" (click)="router.navigate(['/home'])">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="header-text">
        <h1>Auditoría de Reservas</h1>
        <p class="subtitle">Historial completo de cambios y modificaciones</p>
      </div>
    </div>
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="exportarCSV()">
        <mat-icon>download</mat-icon>
        EXPORTAR CSV
      </button>
    </div>
  </div>

  <!-- Filtros -->
  <mat-card class="filtros-card">
    <mat-card-content>
      <form [formGroup]="filtrosForm" class="filtros-form">
        <div class="filtros-grid">
          <mat-form-field appearance="outline" class="filtro-field">
            <mat-label>Tipo de Acción</mat-label>
            <mat-select formControlName="accion">
              <mat-option value="">Todas las acciones</mat-option>
              <mat-option *ngFor="let tipo of tiposAccion" [value]="tipo">
                {{ tipo }}
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>filter_list</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline" class="filtro-field">
            <mat-label>Usuario</mat-label>
            <input matInput formControlName="usuario" placeholder="Nombre del usuario">
            <mat-icon matPrefix>person</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline" class="filtro-field">
            <mat-label>Fecha Inicio</mat-label>
            <input matInput [matDatepicker]="pickerInicio" formControlName="fechaInicio">
            <mat-datepicker-toggle matSuffix [for]="pickerInicio"></mat-datepicker-toggle>
            <mat-datepicker #pickerInicio></mat-datepicker>
            <mat-icon matPrefix>event</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline" class="filtro-field">
            <mat-label>Fecha Fin</mat-label>
            <input matInput [matDatepicker]="pickerFin" formControlName="fechaFin">
            <mat-datepicker-toggle matSuffix [for]="pickerFin"></mat-datepicker-toggle>
            <mat-datepicker #pickerFin></mat-datepicker>
            <mat-icon matPrefix>event</mat-icon>
          </mat-form-field>
        </div>

        <div class="filtros-actions">
          <button mat-raised-button color="primary" (click)="aplicarFiltros()" [disabled]="loading">
            <mat-icon>search</mat-icon>
            BUSCAR
          </button>
          <button mat-button (click)="limpiarFiltros()">
            <mat-icon>clear</mat-icon>
            LIMPIAR
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Tabla de Registros -->
  <mat-card class="tabla-card">
    <mat-card-content>
      <!-- Loading Spinner -->
      <div class="loading-container" *ngIf="loading">
        <mat-spinner diameter="50"></mat-spinner>
        <p>Cargando historial de auditoría...</p>
      </div>

      <!-- Tabla -->
      <div class="table-container" *ngIf="!loading">
        <table mat-table [dataSource]="registros" class="auditoria-table">
          
          <!-- Fecha Column -->
          <ng-container matColumnDef="fecha">
            <th mat-header-cell *matHeaderCellDef>Fecha y Hora</th>
            <td mat-cell *matCellDef="let registro">
              <div class="fecha-cell">
                <mat-icon class="cell-icon">schedule</mat-icon>
                <span>{{ formatearFecha(registro.cambio.fecha) }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Acción Column -->
          <ng-container matColumnDef="accion">
            <th mat-header-cell *matHeaderCellDef>Acción</th>
            <td mat-cell *matCellDef="let registro">
              <mat-chip [color]="getColorAccion(registro.cambio.accion)" class="accion-chip">
                <mat-icon>{{ getIconoAccion(registro.cambio.accion) }}</mat-icon>
                {{ registro.cambio.accion }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Usuario Column -->
          <ng-container matColumnDef="usuario">
            <th mat-header-cell *matHeaderCellDef>Usuario</th>
            <td mat-cell *matCellDef="let registro">
              <div class="usuario-cell">
                <mat-icon class="cell-icon">account_circle</mat-icon>
                <div class="usuario-info">
                  <span class="usuario-nombre">{{ registro.cambio.usuario }}</span>
                  <span class="usuario-rol" *ngIf="registro.cambio.rol">{{ registro.cambio.rol }}</span>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Reserva Column -->
          <ng-container matColumnDef="reserva">
            <th mat-header-cell *matHeaderCellDef>Reserva</th>
            <td mat-cell *matCellDef="let registro">
              <div class="reserva-cell">
                <div class="reserva-cliente">
                  <mat-icon class="cell-icon">person</mat-icon>
                  <strong>{{ registro.cliente.nombre }} {{ registro.cliente.apellido }}</strong>
                </div>
                <div class="reserva-habitacion">
                  <mat-icon class="cell-icon">hotel</mat-icon>
                  <span>Hab {{ registro.habitacion?.numero || 'N/A' }}</span>
                </div>
                <div class="reserva-estado">
                  <mat-chip class="estado-chip" [ngClass]="'estado-' + registro.estado.toLowerCase()">
                    {{ registro.estado }}
                  </mat-chip>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Detalles Column -->
          <ng-container matColumnDef="detalles">
            <th mat-header-cell *matHeaderCellDef>Detalles del Cambio</th>
            <td mat-cell *matCellDef="let registro">
              <div class="detalles-cell">
                <mat-icon class="cell-icon">info</mat-icon>
                <span class="detalles-texto">{{ registro.cambio.detalles }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Acciones Column -->
          <ng-container matColumnDef="acciones">
            <th mat-header-cell *matHeaderCellDef>Acciones</th>
            <td mat-cell *matCellDef="let registro">
              <button mat-icon-button 
                      color="primary" 
                      (click)="verDetalleReserva(registro.reservaId)"
                      matTooltip="Ver reserva completa">
                <mat-icon>visibility</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="registro-row"></tr>
        </table>

        <!-- Sin resultados -->
        <div class="no-results" *ngIf="registros.length === 0 && !loading">
          <mat-icon>search_off</mat-icon>
          <h3>No se encontraron registros</h3>
          <p>Intenta ajustar los filtros de búsqueda</p>
        </div>
      </div>

      <!-- Paginación -->
      <mat-paginator 
        *ngIf="!loading && registros.length > 0"
        [length]="totalRegistros"
        [pageSize]="pageSize"
        [pageSizeOptions]="pageSizeOptions"
        [pageIndex]="pageIndex"
        (page)="onPageChange($event)"
        showFirstLastButtons>
      </mat-paginator>
    </mat-card-content>
  </mat-card>

  <!-- Información adicional -->
  <mat-card class="info-card">
    <mat-card-content>
      <div class="info-content">
        <mat-icon>info</mat-icon>
        <div class="info-text">
          <h4>Acerca de la Auditoría</h4>
          <p>
            Este sistema registra automáticamente todos los cambios realizados en las reservas, incluyendo:
          </p>
          <ul>
            <li><strong>Drag & Drop:</strong> Movimientos de reservas entre fechas/habitaciones</li>
            <li><strong>Modificaciones Manuales:</strong> Ediciones directas de datos</li>
            <li><strong>Cambios de Estado:</strong> Check-in, check-out, cancelaciones</li>
            <li><strong>Pagos:</strong> Registros y modificaciones de pagos</li>
          </ul>
          <p class="warning-text">
            ⚠️ Los cambios por Drag & Drop requieren confirmación y quedan registrados con el usuario responsable.
          </p>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>
