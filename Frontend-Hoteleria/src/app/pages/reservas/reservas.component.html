<div class="page-container">

  <!-- Header de la Página -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">Gestión de Reservas</h1>
      <p class="page-subtitle">Administra, filtra y gestiona todas las reservas del hostal.</p>
    </div>
    <div class="header-actions">
      <button mat-flat-button color="primary" (click)="nuevaReserva()" class="btn-create">
        <mat-icon>add</mat-icon>
        Nueva Reserva
      </button>
      <button mat-stroked-button (click)="exportarReservas()">
        <mat-icon>download</mat-icon>
        Exportar
      </button>
    </div>
  </div>

  <!-- Notificación de Reembolsos (Solo si hay) -->
  <div *ngIf="mostrarNotificacionReembolso" class="alert-banner warning">
    <div class="alert-content">
      <div class="alert-icon-box">
        <mat-icon>payments</mat-icon>
      </div>
      <div class="alert-text">
        <strong>Reembolsos Pendientes</strong>
        <span>Tienes {{ reembolsosPendientes }} reembolso(s) que requieren atención inmediata.</span>
      </div>
    </div>
    <button mat-stroked-button color="warn" (click)="irAAuditoria()">
      Procesar Ahora
    </button>
  </div>

  <!-- KPIs / Estadísticas Rápidas -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon primary-bg">
        <mat-icon>bookmark</mat-icon>
      </div>
      <div class="stat-info">
        <span class="stat-label">Total Reservas</span>
        <span class="stat-value">{{ totalReservas }}</span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon accent-bg">
        <mat-icon>event</mat-icon>
      </div>
      <div class="stat-info">
        <span class="stat-label">Reservas Futuras</span>
        <span class="stat-value">{{ reservasFuturas }}</span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon success-bg">
        <mat-icon>today</mat-icon>
      </div>
      <div class="stat-info">
        <span class="stat-label">Check-ins Hoy</span>
        <span class="stat-value">{{ reservasHoy }}</span>
      </div>
    </div>
  </div>

  <!-- Sección Principal: Filtros y Tabla -->
  <div class="main-content-card">

    <!-- Barra de Herramientas y Filtros -->
    <div class="toolbar-section" [formGroup]="filtrosForm">
      <div class="search-box">
        <mat-icon>search</mat-icon>
        <input type="text" placeholder="Buscar por cliente..." formControlName="cliente">
      </div>

      <div class="filters-group">
        <mat-form-field appearance="outline" subscriptSizing="dynamic" class="small-field">
          <mat-label>Estado</mat-label>
          <mat-select formControlName="estado">
            <mat-option value="">Todos</mat-option>
            <mat-option *ngFor="let estado of estadosReserva" [value]="estado.value">
              {{ estado.label }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" subscriptSizing="dynamic" class="small-field">
          <mat-label>Habitación</mat-label>
          <input matInput formControlName="habitacion" placeholder="N°">
        </mat-form-field>

        <mat-form-field appearance="outline" subscriptSizing="dynamic" class="small-field">
          <mat-label>Rango por Estadía</mat-label>
          <mat-date-range-input [rangePicker]="pickerRango">
            <input matStartDate formControlName="fechaInicio" placeholder="Inicio">
            <input matEndDate formControlName="fechaFin" placeholder="Fin">
          </mat-date-range-input>
          <mat-datepicker-toggle matSuffix [for]="pickerRango"></mat-datepicker-toggle>
          <mat-date-range-picker #pickerRango></mat-date-range-picker>
        </mat-form-field>

        <button mat-icon-button class="refresh-btn" (click)="cargarTodasLasReservas()" matTooltip="Recargar datos">
          <mat-icon>refresh</mat-icon>
        </button>

        <button mat-flat-button color="primary" (click)="aplicarFiltros()" class="btn-search">
          Buscar
        </button>
        <button mat-button color="warn" (click)="limpiarFiltros()" *ngIf="filtrosForm.dirty" class="btn-clear">
          Limpiar
        </button>
      </div>
    </div>

    <!-- Tabla de Datos -->
    <div class="table-frame">
      <div class="loading-shade" *ngIf="loading">
        <mat-spinner diameter="40"></mat-spinner>
      </div>

      <table mat-table [dataSource]="dataSource" matSort class="modern-table">

        <!-- Cliente -->
        <ng-container matColumnDef="cliente">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Cliente</th>
          <td mat-cell *matCellDef="let reserva">
            <div class="user-cell">
              <div class="user-avatar-small">{{ reserva.cliente.nombre.charAt(0) }}</div>
              <div class="user-details">
                <span class="user-name">{{ reserva.cliente.nombre }} {{ reserva.cliente.apellido }}</span>
                <span class="user-doc">{{ reserva.cliente.documento }}</span>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Habitación -->
        <ng-container matColumnDef="habitacion">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Habitación</th>
          <td mat-cell *matCellDef="let reserva">
            <div class="room-cell" *ngIf="reserva.habitacionDetalle">
              <span class="room-number">Hab {{ reserva.habitacionDetalle.numero }}</span>
              <span class="room-type">{{ reserva.habitacionDetalle.tipo }}</span>
            </div>
            <div *ngIf="!reserva.habitacionDetalle" class="muted-text">N/A</div>
          </td>
        </ng-container>

        <!-- Fechas -->
        <ng-container matColumnDef="fechas">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Estadía</th>
          <td mat-cell *matCellDef="let reserva">
            <div class="date-cell">
              <div class="date-row">
                <mat-icon class="date-icon-in">login</mat-icon>
                <span>{{ formatearFecha(reserva.fechaEntrada) }}</span>
              </div>
              <div class="date-row">
                <mat-icon class="date-icon-out">logout</mat-icon>
                <span>{{ formatearFecha(reserva.fechaSalida) }}</span>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Días -->
        <ng-container matColumnDef="dias">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Duración</th>
          <td mat-cell *matCellDef="let reserva">
            <span class="days-badge">{{ reserva.diasEstancia }} noches</span>
          </td>
        </ng-container>

        <!-- Estado -->
        <ng-container matColumnDef="estado">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Estado</th>
          <td mat-cell *matCellDef="let reserva">
            <span class="status-badge" [ngClass]="reserva.estado | lowercase" [style.color]="reserva.estadoColor"
              [style.borderColor]="reserva.estadoColor + '40'" [style.backgroundColor]="reserva.estadoColor + '15'">
              {{ reserva.estado }}
            </span>
          </td>
        </ng-container>

        <!-- Pago -->
        <ng-container matColumnDef="pago">
          <th mat-header-cell *matHeaderCellDef>Pago</th>
          <td mat-cell *matCellDef="let reserva">
            <div class="payment-cell">
              <span class="payment-badge" [ngClass]="obtenerEstadoPago(reserva).texto.toLowerCase().replace(' ', '-')">
                <mat-icon class="tiny-icon">{{ obtenerEstadoPago(reserva).icon }}</mat-icon>
                {{ obtenerEstadoPago(reserva).texto }}
              </span>
              <span class="payment-amount" *ngIf="reserva.montoPagado > 0">{{ formatearPrecio(reserva.montoPagado)
                }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Precio -->
        <ng-container matColumnDef="precio">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Total</th>
          <td mat-cell *matCellDef="let reserva">
            <span class="price-total">{{ formatearPrecio(reserva.precioTotal) }}</span>
          </td>
        </ng-container>

        <!-- Acciones -->
        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let reserva">
            <button mat-icon-button [matMenuTriggerFor]="menuAcciones">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #menuAcciones="matMenu">
              <button mat-menu-item (click)="verDetalle(reserva)">
                <mat-icon>visibility</mat-icon> Ver Detalles
              </button>
              <button mat-menu-item (click)="editarReserva(reserva)">
                <mat-icon>edit</mat-icon> Editar
              </button>
              <button mat-menu-item class="menu-danger" (click)="cancelarReserva(reserva)"
                [disabled]="reserva.estado === 'Cancelada'">
                <mat-icon>cancel</mat-icon> Cancelar
              </button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" [class.row-today]="esReservaHoy(row.fechaEntrada)">
        </tr>
      </table>

      <mat-paginator [pageSizeOptions]="[10, 25, 50]" showFirstLastButtons></mat-paginator>
    </div>
  </div>
</div>