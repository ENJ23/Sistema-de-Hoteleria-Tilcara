<div class="dashboard-container">
  <!-- Header del Dashboard -->
  <!-- Header Principal -->
  <!-- Header del Dashboard -->
  <div class="dashboard-header-wrapper">
    <div class="dashboard-header-card">
      <div class="header-text">
        <div class="title-group">
          <div class="icon-box">
            <mat-icon>dashboard</mat-icon>
          </div>
          <div>
            <h1 class="dashboard-title">Dashboard General</h1>
            <p class="dashboard-subtitle">Visión general de ingresos, reservas y métricas clave.</p>
          </div>
        </div>
      </div>

      <div class="header-actions">
        <span class="current-date">
          <mat-icon>today</mat-icon>
          {{ fechaActual | date:'EEEE, d MMMM y' | titlecase }}
        </span>
      </div>
    </div>
  </div>

  <!-- Barra de Herramientas (Filtros y Acciones) -->
  <div class="dashboard-toolbar">
    <!-- Navegación de Mes -->
    <div class="month-selector">
      <button mat-icon-button (click)="cambiarMes('anterior')" matTooltip="Mes anterior">
        <mat-icon>chevron_left</mat-icon>
      </button>
      <span class="month-label">{{ obtenerNombreMes(mesActual.getMonth()) }} {{ mesActual.getFullYear() }}</span>
      <button mat-icon-button (click)="cambiarMes('siguiente')" matTooltip="Mes siguiente">
        <mat-icon>chevron_right</mat-icon>
      </button>
      <button mat-stroked-button (click)="irAHoy()" class="btn-hoy">
        Hoy
      </button>
    </div>

    <div class="toolbar-spacer"></div>

    <!-- Filtro de Rango (El que pidió el usuario) -->
    <form class="custom-range-form" [formGroup]="filtrosForm" (ngSubmit)="onAplicarRango()">
      <div class="range-inputs">
        <mat-form-field appearance="outline" density="compact" class="date-field">
          <mat-label>Desde</mat-label>
          <input matInput [matDatepicker]="pickerInicio" formControlName="fechaInicio">
          <mat-datepicker-toggle matSuffix [for]="pickerInicio"></mat-datepicker-toggle>
          <mat-datepicker #pickerInicio></mat-datepicker>
        </mat-form-field>
        <span class="range-separator">al</span>
        <mat-form-field appearance="outline" density="compact" class="date-field">
          <mat-label>Hasta</mat-label>
          <input matInput [matDatepicker]="pickerFin" formControlName="fechaFin">
          <mat-datepicker-toggle matSuffix [for]="pickerFin"></mat-datepicker-toggle>
          <mat-datepicker #pickerFin></mat-datepicker>
        </mat-form-field>
      </div>
      <button mat-icon-button color="primary" type="submit" matTooltip="Aplicar filtro presonalizado" class="btn-apply">
        <mat-icon>filter_list</mat-icon>
      </button>
    </form>

    <div class="toolbar-divider"></div>

    <!-- Acciones -->
    <div class="export-actions">
      <button mat-stroked-button class="btn-excel" (click)="exportarExcel()" matTooltip="Descargar Excel">
        <mat-icon>table_chart</mat-icon>
        <span class="btn-label">Excel</span>
      </button>
      <button mat-stroked-button class="btn-pdf" (click)="exportarPDF()" matTooltip="Descargar PDF">
        <mat-icon>picture_as_pdf</mat-icon>
        <span class="btn-label">PDF</span>
      </button>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Cargando datos del dashboard...</p>
  </div>

  <!-- Contenido del Dashboard -->
  <div *ngIf="!loading" class="dashboard-content">

    <!-- Cotización Dólar y Resumen Principal -->
    <!-- KPIs Principales -->
    <div class="kpi-grid">

      <!-- Cotización USD -->
      <mat-card class="kpi-card dolar">
        <div class="kpi-content">
          <div class="kpi-icon-wrapper">
            <mat-icon>currency_exchange</mat-icon>
          </div>
          <div class="kpi-data">
            <span class="kpi-label">Cotización USD</span>
            <div class="dolar-input-wrapper">
              <span class="currency-symbol">$</span>
              <input type="number" [(ngModel)]="valorDolar" (ngModelChange)="actualizarValorDolar($event)"
                class="dolar-input">
            </div>
          </div>
        </div>
      </mat-card>

      <!-- Ingresos Totales -->
      <mat-card class="kpi-card total">
        <div class="kpi-content">
          <div class="kpi-icon-wrapper">
            <mat-icon>payments</mat-icon>
          </div>
          <div class="kpi-data">
            <span class="kpi-label">Ingresos Totales</span>
            <span class="kpi-value">{{ formatearPrecio(resumen.totalIngresos) }}</span>
            <span class="kpi-subtext" *ngIf="valorDolar > 0">≈ {{ formatearDolar(resumen.totalIngresos) }}</span>
          </div>
        </div>
        <div class="kpi-footer">
          <span class="trend neutral">{{ resumen.totalReservas }} reservas</span>
        </div>
      </mat-card>

      <!-- Completamente Pagadas -->
      <!--
      <mat-card class="kpi-card success">
        <div class="kpi-content">
          <div class="kpi-icon-wrapper">
            <mat-icon>check_circle_outline</mat-icon>
          </div>
          <div class="kpi-data">
            <span class="kpi-label">Completados</span>
            <span class="kpi-value">{{ formatearPrecio(resumen.ingresosCompletos) }}</span>
            <span class="kpi-subtext">{{ resumen.reservasCompletas }} reservas</span>
          </div>
        </div>
        <div class="kpi-footer">
          <mat-progress-bar mode="determinate"
            [value]="resumen.totalReservas > 0 ? (resumen.reservasCompletas / resumen.totalReservas) * 100 : 0"></mat-progress-bar>
        </div>
      </mat-card>
      -->

      <!-- Parcialmente Pagadas -->
      <mat-card class="kpi-card warning">
        <div class="kpi-content">
          <div class="kpi-icon-wrapper">
            <mat-icon>pending_actions</mat-icon>
          </div>
          <div class="kpi-data">
            <span class="kpi-label">Pendiente</span>
            <span class="kpi-value">{{ formatearPrecio(resumen.ingresosParciales) }}</span>
            <span class="kpi-subtext">{{ resumen.reservasParciales }} reservas</span>
          </div>
        </div>
        <div class="kpi-footer">
          <mat-progress-bar mode="determinate" color="accent"
            [value]="resumen.totalReservas > 0 ? (resumen.reservasParciales / resumen.totalReservas) * 100 : 0"></mat-progress-bar>
        </div>
      </mat-card>
    </div>

    <!-- Detalle de pagos del rango (lista desplegable) -->
    <mat-accordion class="pagos-card-container" multi="true">
      <mat-expansion-panel [expanded]="false" class="pagos-main-panel">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <div class="panel-title-content">
              <div class="icon-badge">
                <mat-icon>payments</mat-icon>
              </div>
              <span class="panel-label">Pagos en el rango</span>
              <span class="panel-count">{{ pagosFiltrados.length }}</span>
            </div>
          </mat-panel-title>
          <mat-panel-description>
            <span class="description-text">Ver desglose detallado</span>
            <mat-icon class="info-icon" 
                      matTooltip="Los pagos se muestran según su fecha de pago, no la fecha de creación de la reserva"
                      matTooltipPosition="above">
              info_outline
            </mat-icon>
          </mat-panel-description>
        </mat-expansion-panel-header>

        <!-- Campo de búsqueda -->
        <div class="search-pagos-container">
          <mat-form-field appearance="outline" subscriptSizing="dynamic" class="search-pagos-field">
            <mat-label>Buscar en pagos</mat-label>
            <input matInput [(ngModel)]="searchPagosText" placeholder="Nombre, apellido o monto...">
            <mat-icon matPrefix>search</mat-icon>
            <button mat-icon-button matSuffix *ngIf="searchPagosText" (click)="searchPagosText = ''" aria-label="Limpiar">
              <mat-icon>close</mat-icon>
            </button>
          </mat-form-field>
        </div>

        <div class="pagos-list-container" *ngIf="pagosFiltrados.length; else sinPagos">
          <mat-accordion multi="true" class="inner-payments-accordion">
            <mat-expansion-panel *ngFor="let pago of pagosFiltrados" class="payment-panel">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  <div class="payment-header-title">
                    <mat-icon class="text-primary">calendar_today</mat-icon>
                    <span>{{ formatearFecha(pago.fechaPago) }}</span>
                  </div>
                </mat-panel-title>
                <mat-panel-description>
                  <div class="payment-header-desc">
                    <span class="room-chip">Hab {{ pago.habitacionNumero || '?' }}</span>
                    <span class="amount-highlight">{{ formatearPrecio(pago.monto) }}</span>
                  </div>
                </mat-panel-description>
              </mat-expansion-panel-header>

              <div class="payment-detail-grid">
                <!-- Info Cliente -->
                <div class="detail-item">
                  <div class="detail-icon"><mat-icon>person</mat-icon></div>
                  <div class="detail-content">
                    <span class="label">Cliente</span>
                    <span class="value">{{ (pago.clienteNombre || '') + ' ' + (pago.clienteApellido || 'Desconocido')
                      }}</span>
                  </div>
                </div>

                <!-- Info Habitación -->
                <div class="detail-item">
                  <div class="detail-icon"><mat-icon>hotel</mat-icon></div>
                  <div class="detail-content">
                    <span class="label">Habitación</span>
                    <span class="value">{{ pago.habitacionNumero || 'N/A' }} <span class="sub-value">({{
                        pago.habitacionTipo }})</span></span>
                  </div>
                </div>

                <!-- Fecha Entrada -->
                <div class="detail-item">
                  <div class="detail-icon"><mat-icon>login</mat-icon></div>
                  <div class="detail-content">
                    <span class="label">Fecha Entrada</span>
                    <span class="value">{{ pago.fechaEntrada ? formatearFecha(pago.fechaEntrada) : 'N/A' }}</span>
                  </div>
                </div>

                <!-- Fecha Salida -->
                <div class="detail-item">
                  <div class="detail-icon"><mat-icon>logout</mat-icon></div>
                  <div class="detail-content">
                    <span class="label">Fecha Salida</span>
                    <span class="value">{{ pago.fechaSalida ? formatearFecha(pago.fechaSalida) : 'N/A' }}</span>
                  </div>
                </div>

                <!-- Estado -->
                <div class="detail-item">
                  <div class="detail-icon"><mat-icon>info</mat-icon></div>
                  <div class="detail-content">
                    <span class="label">Estado Reserva</span>
                    <span class="value badge-status">{{ pago.estadoReserva || 'Desconocido' }}</span>
                  </div>
                </div>

                <!-- Monto (Grande) -->
                <div class="detail-item full-width highlight-box">
                  <div class="detail-icon"><mat-icon>payments</mat-icon></div>
                  <div class="detail-content">
                    <span class="label">Monto Abonado</span>
                    <span class="value large-amount">{{ formatearPrecio(pago.monto) }}</span>
                  </div>
                </div>
              </div>
            </mat-expansion-panel>
          </mat-accordion>
        </div>

        <ng-template #sinPagos>
          <div class="no-data">
            <mat-icon>receipt_long</mat-icon>
            <p *ngIf="!searchPagosText">No se registraron pagos en este período</p>
            <p *ngIf="searchPagosText">No se encontraron pagos que coincidan con "{{ searchPagosText }}"</p>
          </div>
        </ng-template>
      </mat-expansion-panel>
    </mat-accordion>

    <!-- Resumen Anual -->
    <div class="resumen-anual-container">
      <div class="section-header">
        <div class="title-with-icon">
          <mat-icon>calendar_today</mat-icon>
          <h2>Resumen Anual {{ resumenAnual.year }}</h2>
        </div>
      </div>

      <div *ngIf="loadingAnual" class="loading-state">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Calculando ingresos anuales...</p>
      </div>

      <div *ngIf="!loadingAnual" class="kpi-grid">
        <mat-card class="kpi-card total">
          <div class="kpi-content">
            <div class="kpi-icon-wrapper">
              <mat-icon>monetization_on</mat-icon>
            </div>
            <div class="kpi-data">
              <span class="kpi-label">Ingresos Anuales</span>
              <span class="kpi-value">{{ formatearPrecio(resumenAnual.totalIngresos) }}</span>
              <span class="kpi-subtext" *ngIf="valorDolar > 0">≈ {{ formatearDolar(resumenAnual.totalIngresos) }}</span>
            </div>
          </div>
          <div class="kpi-footer">
            <span class="trend neutral">{{ resumenAnual.totalReservas }} reservas en total</span>
          </div>
        </mat-card>

        <mat-card class="kpi-card info">
          <div class="kpi-content">
            <div class="kpi-icon-wrapper">
              <mat-icon>timeline</mat-icon>
            </div>
            <div class="kpi-data">
              <span class="kpi-label">Promedio Mensual</span>
              <span class="kpi-value">{{ formatearPrecio(resumenAnual.promedioMensual) }}</span>
              <span class="kpi-subtext" *ngIf="valorDolar > 0">≈ {{ formatearDolar(resumenAnual.promedioMensual)
                }}</span>
            </div>
          </div>
          <div class="kpi-footer">
            <span class="trend neutral">Ingreso promedio / mes</span>
          </div>
        </mat-card>
      </div>

      <!-- Desglose por Habitación Anual -->
      <mat-expansion-panel class="anual-expansion">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <mat-icon class="text-icon">list</mat-icon>
            Ver Desglose Anual por Habitación
          </mat-panel-title>
        </mat-expansion-panel-header>

        <div class="tipo-habitacion-list">
          <div class="tipo-item" *ngFor="let hab of ingresosPorHabitacionAnual">
            <div class="tipo-row-main">
              <div class="tipo-info">
                <div class="tipo-nombre">Habitación {{ hab.numero }}</div>
                <div class="tipo-cantidad">{{ hab.cantidad }} reservas</div>
              </div>
              <div class="tipo-ingresos">
                <div class="tipo-monto">{{ formatearPrecio(hab.ingresos) }}</div>
                <div class="tipo-porcentaje">{{ hab.porcentaje.toFixed(1) }}% del anual</div>
              </div>
            </div>
            <div class="progress-track">
              <div class="progress-fill accent-fill" [style.width.%]="hab.porcentaje"></div>
            </div>
          </div>
        </div>
      </mat-expansion-panel>
    </div>

    <!-- Estadísticas Detalladas -->
    <!-- Estadísticas Detalladas -->
    <div class="estadisticas-detalladas">
      <!-- Estadísticas de Pago -->
      <mat-card class="estadisticas-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon class="card-icon-header">analytics</mat-icon>
            Estadísticas de Pago
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="stats-blocks-container">
            <!-- Pagadas -->
            <div class="stat-block success-block">
              <div class="block-icon">
                <mat-icon>check_circle</mat-icon>
              </div>
              <div class="block-content">
                <span class="block-value">{{ resumen.reservasCompletas }}</span>
                <span class="block-label">Completas</span>
                <span class="block-percent">
                  {{ resumen.totalReservas > 0 ? ((resumen.reservasCompletas / resumen.totalReservas) * 100).toFixed(0)
                  : 0 }}%
                </span>
              </div>
            </div>

            <!-- Parciales -->
            <div class="stat-block warning-block">
              <div class="block-icon">
                <mat-icon>schedule</mat-icon>
              </div>
              <div class="block-content">
                <span class="block-value">{{ resumen.reservasParciales }}</span>
                <span class="block-label">Parciales</span>
                <span class="block-percent">
                  {{ resumen.totalReservas > 0 ? ((resumen.reservasParciales / resumen.totalReservas) * 100).toFixed(0)
                  : 0 }}%
                </span>
              </div>
            </div>

            <!-- Sin Pago -->
            <div class="stat-block error-block">
              <div class="block-icon">
                <mat-icon>cancel</mat-icon>
              </div>
              <div class="block-content">
                <span class="block-value">{{ resumen.reservasSinPago }}</span>
                <span class="block-label">Sin Pago</span>
                <span class="block-percent">
                  {{ resumen.totalReservas > 0 ? ((resumen.reservasSinPago / resumen.totalReservas) * 100).toFixed(0) :
                  0 }}%
                </span>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Columna Derecha: Listas de Ingresos -->
      <div class="income-lists-column">

        <!-- Ingresos por Tipo -->
        <mat-card class="tipo-habitacion-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon class="card-icon-header">hotel</mat-icon>
              Por Tipo de Habitación
            </mat-card-title>
          </mat-card-header>
          <mat-card-content class="compact-content">
            <div class="tipo-habitacion-list" *ngIf="ingresosPorTipo.length > 0; else noData">
              <div class="tipo-item" *ngFor="let tipo of ingresosPorTipo">
                <div class="tipo-row-main">
                  <div class="tipo-info">
                    <div class="tipo-nombre">{{ tipo.tipo }}</div>
                    <div class="tipo-cantidad">{{ tipo.cantidad }} reservas</div>
                  </div>
                  <div class="tipo-ingresos">
                    <div class="tipo-monto">{{ formatearPrecio(tipo.ingresos) }}</div>
                    <div class="tipo-porcentaje">{{ tipo.porcentaje.toFixed(1) }}%</div>
                  </div>
                </div>
                <div class="progress-track">
                  <div class="progress-fill" [style.width.%]="tipo.porcentaje"></div>
                </div>
              </div>
            </div>
            <ng-template #noData>
              <div class="no-data-compact">
                <mat-icon>info</mat-icon>
                <span>Sin datos</span>
              </div>
            </ng-template>
          </mat-card-content>
        </mat-card>

        <!-- Ingresos por Habitación -->
        <mat-card class="tipo-habitacion-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon class="card-icon-header">meeting_room</mat-icon>
              Por Habitación
            </mat-card-title>
          </mat-card-header>
          <mat-card-content class="compact-content">
            <div class="tipo-habitacion-list scrollable-list" *ngIf="ingresosPorHabitacion.length > 0; else noDataHab">
              <div class="tipo-item" *ngFor="let hab of ingresosPorHabitacion">
                <div class="tipo-row-main">
                  <div class="tipo-info">
                    <div class="tipo-nombre">Habitacion {{ hab.numero }}</div>
                    <div class="tipo-cantidad">{{ hab.cantidad }} reservas</div>
                  </div>
                  <div class="tipo-ingresos">
                    <div class="tipo-monto">{{ formatearPrecio(hab.ingresos) }}</div>
                    <div class="tipo-porcentaje">{{ hab.porcentaje.toFixed(1) }}%</div>
                  </div>
                </div>
                <div class="progress-track">
                  <div class="progress-fill accent-fill" [style.width.%]="hab.porcentaje"></div>
                </div>
              </div>
            </div>
            <ng-template #noDataHab>
              <div class="no-data-compact">
                <mat-icon>info</mat-icon>
                <span>Sin datos</span>
              </div>
            </ng-template>
          </mat-card-content>
        </mat-card>

      </div>
    </div>

    <!-- Reservas Recientes -->
    <mat-card class="reservas-recientes-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>history</mat-icon>
          Reservas Recientes
        </mat-card-title>
        <mat-card-subtitle>Últimas 5 reservas del mes</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="reservas-table" *ngIf="resumen.reservasRecientes.length > 0; else noReservas">
          <div class="reserva-item" *ngFor="let reserva of resumen.reservasRecientes">
            <div class="reserva-cliente">
              <div class="cliente-nombre">{{ reserva.cliente.nombre }} {{ reserva.cliente.apellido }}</div>
              <div class="cliente-documento">{{ reserva.cliente.documento }}</div>
            </div>

            <div class="reserva-habitacion">
              <div class="habitacion-numero" *ngIf="typeof reserva.habitacion === 'object'">
                {{ getHabitacionNumero(reserva) }}
              </div>
              <div class="habitacion-tipo" *ngIf="typeof reserva.habitacion === 'object'">
                {{ getHabitacionTipo(reserva) }}
              </div>
            </div>

            <div class="reserva-fechas">
              <div class="fecha-entrada">{{ formatearFecha(reserva.fechaEntrada) }}</div>
              <div class="fecha-salida">{{ formatearFecha(reserva.fechaSalida) }}</div>
            </div>

            <div class="reserva-estado">
              <mat-chip [style.background-color]="obtenerEstadoPago(reserva).color" [style.color]="'white'">
                <mat-icon>{{ obtenerEstadoPago(reserva).icon }}</mat-icon>
                {{ obtenerEstadoPago(reserva).texto }}
              </mat-chip>
            </div>

            <div class="reserva-ingresos">
              <div class="ingresos-monto">{{ formatearPrecio(reserva.montoPagado || 0) }}</div>
              <div class="ingresos-total">de {{ formatearPrecio(reserva.precioTotal || 0) }}</div>
            </div>
          </div>
        </div>
        <ng-template #noReservas>
          <div class="no-data">
            <mat-icon>info</mat-icon>
            <p>No hay reservas recientes para este período</p>
          </div>
        </ng-template>
      </mat-card-content>
      <mat-card-actions>
        <button mat-button color="primary" (click)="verReservas()">
          <mat-icon>list</mat-icon>
          Ver Todas las Reservas
        </button>
        <button mat-button (click)="actualizarDatos()">
          <mat-icon>refresh</mat-icon>
          Actualizar
        </button>
      </mat-card-actions>
    </mat-card>
  </div>
</div>